{{define "activity-content"}}
<div class="header">
    <h1>Activity</h1>
    <button class="btn" onclick="location.reload()">ðŸ”„ Refresh</button>
</div>

<div class="activity-section">
    <h2 class="section-title">Queue</h2>
    <div id="activity-list" 
         hx-get="/api/activity/status" 
         hx-trigger="load, every 3s"
         hx-swap="innerHTML">
        <div class="spinner"></div>
    </div>
</div>

<script>
document.body.addEventListener('htmx:afterSwap', function(evt) {
    if(evt.detail.target.id === 'activity-list') {
        try {
            const data = JSON.parse(evt.detail.xhr.responseText);
            renderActivity(data);
        } catch(e) {
            console.error('Failed to parse activity:', e);
        }
    }
});

function formatBytes(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return (bytes / Math.pow(k, i)).toFixed(2) + ' ' + sizes[i];
}

function getStatusBadge(dl) {
    if (dl.Imported || dl.Placed) {
        return '<span class="status-badge status-imported">Imported</span>';
    } else if (dl.Done) {
        return '<span class="status-badge status-downloaded">Downloaded</span>';
    } else {
        return '<span class="status-badge status-downloading">Downloading</span>';
    }
}

function renderActivity(data) {
    const container = document.getElementById('activity-list');
    
    if(!data.downloads || data.downloads.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">ðŸ’¤</div>
                <h3>No active downloads</h3>
                <p>Downloads will appear here automatically when you add them</p>
            </div>
        `;
        return;
    }

    const html = data.downloads.map(dl => {
        const progress = dl.TotalSize > 0 ? Math.round((dl.Progress / dl.TotalSize) * 100) : 0;
        const downloaded = formatBytes(dl.Progress);
        const total = formatBytes(dl.TotalSize);
        
        return `
            <div class="activity-item">
                <div class="activity-header">
                    <div class="activity-title">
                        <strong>${escapeHtml(dl.Title)}</strong>
                        <span class="activity-range">${escapeHtml(dl.ChapterRange)}</span>
                    </div>
                    ${getStatusBadge(dl)}
                </div>
                <div class="activity-progress">
                    <div class="progress-bar-sonarr">
                        <div class="progress-fill-sonarr" style="width: ${progress}%"></div>
                    </div>
                    <div class="progress-info">
                        <span>${progress}%</span>
                        ${dl.TotalSize > 0 ? `<span>${downloaded} / ${total}</span>` : ''}
                    </div>
                </div>
                ${dl.PlacementProgress ? `
                    <div class="activity-status">${dl.PlacementProgress}</div>
                ` : ''}
            </div>
        `;
    }).join('');
    
    container.innerHTML = html;
}

function escapeHtml(text) {
    if(!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>

{{end}}
