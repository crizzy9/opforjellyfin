{{define "activity-content"}}
<div class="header">
    <h1>Activity & Queue</h1>
    <button class="btn" onclick="location.reload()">üîÑ Refresh</button>
</div>

<div class="card">
    <h2 style="margin-bottom: 20px;">Active Downloads</h2>
    <div id="activity-list" 
         hx-get="/api/activity/status" 
         hx-trigger="load, every 2s"
         hx-swap="innerHTML">
        <div class="spinner"></div>
    </div>
</div>

<script>
document.body.addEventListener('htmx:afterSwap', function(evt) {
    if(evt.detail.target.id === 'activity-list') {
        try {
            const data = JSON.parse(evt.detail.xhr.responseText);
            renderActivity(data);
        } catch(e) {
            console.error('Failed to parse activity:', e);
        }
    }
});

function renderActivity(data) {
    const container = document.getElementById('activity-list');
    
    if(!data.downloads || data.downloads.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">üí§</div>
                <h3>No active downloads</h3>
                <p>Go to Episodes to start downloading</p>
            </div>
        `;
        return;
    }

    const html = `
        <table class="table">
            <thead>
                <tr>
                    <th>Title</th>
                    <th>Progress</th>
                    <th>Status</th>
                    <th>Chapter Range</th>
                </tr>
            </thead>
            <tbody>
                ${data.downloads.map(dl => {
                    const progress = dl.TotalSize > 0 ? Math.round((dl.Progress / dl.TotalSize) * 100) : 0;
                    return `
                        <tr>
                            <td>${escapeHtml(dl.Title)}</td>
                            <td>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${progress}%"></div>
                                </div>
                                <small>${progress}%</small>
                            </td>
                            <td>${dl.Done ? '‚úÖ Complete' : dl.PlacementProgress || '‚è≥ Downloading...'}</td>
                            <td>${escapeHtml(dl.ChapterRange)}</td>
                        </tr>
                    `;
                }).join('')}
            </tbody>
        </table>
    `;
    
    container.innerHTML = html;
}

function escapeHtml(text) {
    if(!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>

{{end}}
