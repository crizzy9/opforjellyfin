{{define "content"}}
<div class="header">
    <h1>One Pace Episodes</h1>
</div>

<div class="search-bar">
    <input 
        type="text" 
        name="search" 
        placeholder="Search episodes..."
        hx-get="/api/episodes/search"
        hx-trigger="keyup changed delay:500ms"
        hx-target="#episodes-list"
        hx-include="[name='title-filter'], [name='range-filter']"
    >
    <input 
        type="text" 
        name="title-filter" 
        placeholder="Filter by title..."
        hx-get="/api/episodes/search"
        hx-trigger="keyup changed delay:500ms"
        hx-target="#episodes-list"
        hx-include="[name='search'], [name='range-filter']"
    >
    <input 
        type="text" 
        name="range-filter" 
        placeholder="Chapter range..."
        hx-get="/api/episodes/search"
        hx-trigger="keyup changed delay:500ms"
        hx-target="#episodes-list"
        hx-include="[name='search'], [name='title-filter']"
    >
    <button class="btn" hx-get="/api/episodes/list" hx-target="#episodes-list">
        üîÑ Refresh
    </button>
</div>

<div id="episodes-list" 
     hx-get="/api/episodes/list" 
     hx-trigger="load"
     hx-swap="innerHTML">
    <div class="spinner"></div>
</div>

<script>
document.body.addEventListener('htmx:beforeSwap', function(evt) {
    if(evt.detail.xhr.status === 404) {
        evt.detail.shouldSwap = true;
        evt.detail.isError = false;
    }
});

document.body.addEventListener('htmx:afterSwap', function(evt) {
    if(evt.detail.target.id === 'episodes-list') {
        try {
            const data = JSON.parse(evt.detail.xhr.responseText);
            renderEpisodes(data);
        } catch(e) {
            console.error('Failed to parse episodes:', e);
        }
    }
});

function renderEpisodes(episodes) {
    const container = document.getElementById('episodes-list');
    
    if(!episodes || episodes.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">üì≠</div>
                <h3>No episodes found</h3>
                <p>Try adjusting your search or run sync in System settings</p>
            </div>
        `;
        return;
    }

    const html = `
        <div class="episodes-grid">
            ${episodes.map(ep => `
                <div class="episode-card">
                    <div class="episode-title">${escapeHtml(ep.TorrentName)}</div>
                    <div class="episode-meta">
                        <span>Chapter: ${escapeHtml(ep.ChapterRange)}</span>
                        <span>Key: #${ep.DownloadKey}</span>
                    </div>
                    <div style="display: flex; gap: 8px; margin-top: 10px;">
                        <span class="badge badge-quality">${escapeHtml(ep.Quality)}</span>
                        <span class="badge badge-seeders">üå± ${ep.Seeders}</span>
                        ${ep.MetaDataAvail ? '<span class="badge badge-metadata">‚úì Metadata</span>' : ''}
                    </div>
                    <div class="episode-actions">
                        <button 
                            class="btn btn-success" 
                            hx-post="/api/episodes/download"
                            hx-vals='{"downloadKey": "${ep.DownloadKey}"}'
                            hx-target="#alert-container"
                            hx-swap="innerHTML"
                        >
                            ‚¨áÔ∏è Download
                        </button>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
    
    container.innerHTML = html;
}

function escapeHtml(text) {
    if(!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>

<div id="alert-container"></div>

{{end}}
{{template "base" .}}
