{{define "settings-content"}}
<div class="header">
    <h1>Settings</h1>
</div>

<div class="card">
    <h2 style="margin-bottom: 20px;">General Settings</h2>
    <form hx-post="/api/settings/update" hx-target="#settings-alert" hx-swap="innerHTML">
        <div class="form-group">
            <label for="targetDir">Target Directory (Media Library)</label>
            <div style="display: flex; gap: 10px;">
                <input 
                    type="text" 
                    id="targetDir" 
                    name="targetDir" 
                    value="{{.Config.TargetDir}}"
                    placeholder="/data/media/One Piece/One Pace"
                    required
                    style="flex: 1;"
                >
                <button 
                    type="button" 
                    class="btn" 
                    onclick="showDirectoryBrowser('targetDir')"
                >
                    ğŸ“ Browse
                </button>
            </div>
            <small style="color: var(--secondary-text);">
                Final destination where One Pace episodes will be organized. This is where Jellyfin/Plex will read files from.
            </small>
        </div>

        <div class="form-group">
            <small style="color: var(--secondary-text);">
                Directory where your torrent client saves completed downloads. Files will be hardlinked from here to the target directory. Leave blank to use target directory directly.
            </small>
        </div>

        <button type="submit" class="btn btn-success">ğŸ’¾ Save Settings</button>
    </form>
</div>

<div id="directory-browser" style="display: none; margin-top: 20px;" class="card">
    <h3 style="margin-bottom: 15px;">Browse Directories</h3>
    <div style="margin-bottom: 15px;">
        <strong>Current Path:</strong> <span id="current-path">/</span>
    </div>
    <div id="directory-list" style="max-height: 400px; overflow-y: auto; margin-bottom: 15px; border: 1px solid var(--border-color); border-radius: 5px;">
        <!-- Directory list will be populated here -->
    </div>
    <div style="display: flex; gap: 10px;">
        <button type="button" class="btn btn-success" onclick="selectCurrentDirectory()">âœ“ Select This Directory</button>
        <button type="button" class="btn" onclick="hideDirectoryBrowser()">âœ• Cancel</button>
    </div>
</div>

<div class="card" style="margin-top: 20px;">
    <h2 style="margin-bottom: 20px;">Torrent Client Settings</h2>
    <form hx-post="/api/settings/update" hx-target="#client-alert" hx-swap="innerHTML">
        <div class="form-group">
            <label for="clientType">Client Type</label>
            <select id="clientType" name="clientType">
                <option value="internal" {{if or (eq .Config.TorrentClient.Type "") (eq .Config.TorrentClient.Type "internal")}}selected{{end}}>Internal Client</option>
                <option value="qbittorrent" {{if eq .Config.TorrentClient.Type "qbittorrent"}}selected{{end}}>qBittorrent</option>
                <option value="deluge" {{if eq .Config.TorrentClient.Type "deluge"}}selected{{end}}>Deluge</option>
                <option value="transmission" {{if eq .Config.TorrentClient.Type "transmission"}}selected{{end}}>Transmission</option>
            </select>
        </div>

        <div class="form-group">
            <label for="clientUrl">Client URL</label>
            <input 
                type="text" 
                id="clientUrl" 
                name="clientUrl" 
                value="{{.Config.TorrentClient.URL}}"
                placeholder="http://localhost:8080"
            >
        </div>

        <div class="form-group">
            <label for="clientUsername">Username</label>
            <input 
                type="text" 
                id="clientUsername" 
                name="clientUsername" 
                value="{{.Config.TorrentClient.Username}}"
                placeholder="admin"
            >
        </div>

        <div class="form-group">
            <label for="clientPassword">Password</label>
            <input 
                type="password" 
                id="clientPassword" 
                name="clientPassword"
                value="{{.Config.TorrentClient.Password}}"
            >
            <small style="color: var(--secondary-text);">Leave blank to keep existing password</small>
        </div>

        <button 
            type="button" 
            class="btn" 
            hx-post="/api/settings/test-client"
            hx-target="#client-test-result"
            hx-swap="innerHTML"
        >
            ğŸ§ª Test Connection
        </button>
        <button type="submit" class="btn btn-success">ğŸ’¾ Save Client Settings</button>
        
        <div id="client-test-result" style="margin-top: 15px;"></div>
    </form>
    
    <div id="client-alert" style="margin-top: 20px;"></div>
</div>

<div id="settings-alert" style="margin-top: 20px;"></div>

<script>
let currentBrowsePath = '/data';
let currentBrowseField = 'targetDir';

function showDirectoryBrowser(fieldId) {
    currentBrowseField = fieldId;
    document.getElementById('directory-browser').style.display = 'block';
    const fieldValue = document.getElementById(fieldId).value;
    if (fieldValue) {
        currentBrowsePath = fieldValue;
    }
    browseDirectory(currentBrowsePath);
}

function hideDirectoryBrowser() {
    document.getElementById('directory-browser').style.display = 'none';
}

function selectCurrentDirectory() {
    document.getElementById(currentBrowseField).value = currentBrowsePath;
    hideDirectoryBrowser();
}

function browseDirectory(path) {
    currentBrowsePath = path;
    
    fetch('/api/settings/browse?path=' + encodeURIComponent(path))
        .then(response => response.json())
        .then(data => {
            document.getElementById('current-path').textContent = data.currentPath;
            
            const listHtml = data.directories.map(dir => `
                <div 
                    style="padding: 10px; border-bottom: 1px solid var(--border-color); cursor: pointer; display: flex; align-items: center; gap: 10px;"
                    onclick="browseDirectory('${dir.path.replace(/'/g, "\\'")}')"
                    onmouseover="this.style.backgroundColor='var(--accent-bg)'"
                    onmouseout="this.style.backgroundColor='transparent'"
                >
                    <span style="font-size: 20px;">ğŸ“</span>
                    <span>${escapeHtml(dir.name)}</span>
                </div>
            `).join('');
            
            document.getElementById('directory-list').innerHTML = listHtml || '<p style="text-align: center; color: var(--secondary-text); padding: 20px;">No subdirectories found</p>';
        })
        .catch(error => {
            document.getElementById('directory-list').innerHTML = `
                <div class="alert alert-danger" style="margin: 10px;">
                    âŒ Failed to browse directory: ${error.message}
                </div>
            `;
        });
}

function escapeHtml(text) {
    if(!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

document.body.addEventListener('htmx:afterSwap', function(evt) {
    if(evt.detail.target.id === 'settings-alert' || evt.detail.target.id === 'client-alert') {
        try {
            const data = JSON.parse(evt.detail.xhr.responseText);
            if(data.success) {
                evt.detail.target.innerHTML = `
                    <div class="alert alert-success">
                        âœ… ${data.message}
                    </div>
                `;
            }
        } catch(e) {
            evt.detail.target.innerHTML = `
                <div class="alert alert-danger">
                    âŒ Failed to save settings
                </div>
            `;
        }
        
        setTimeout(() => {
            evt.detail.target.innerHTML = '';
        }, 3000);
    }
    
    if(evt.detail.target.id === 'client-test-result') {
        try {
            const data = JSON.parse(evt.detail.xhr.responseText);
            if(data.success) {
                evt.detail.target.innerHTML = `
                    <div class="alert alert-success">
                        âœ… ${data.message}
                    </div>
                `;
            }
        } catch(e) {
            evt.detail.target.innerHTML = `
                <div class="alert alert-danger">
                    âŒ Connection test failed
                </div>
            `;
        }
        
        setTimeout(() => {
            evt.detail.target.innerHTML = '';
        }, 5000);
    }
});

document.body.addEventListener('htmx:responseError', function(evt) {
    if(evt.detail.target.id === 'client-test-result') {
        evt.detail.target.innerHTML = `
            <div class="alert alert-danger">
                âŒ ${evt.detail.xhr.responseText || 'Connection failed'}
            </div>
        `;
        
        setTimeout(() => {
            evt.detail.target.innerHTML = '';
        }, 5000);
    }
});
</script>

{{end}}
